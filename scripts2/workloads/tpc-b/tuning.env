# =============================================================================
# WORKLOAD CONTEXT: TPC-B (pgbench OLTP)
# =============================================================================
# Optimized for: Write-intensive OLTP transactions
# Benchmark tool: pgbench
# Dataset: ~20GB (scale 1250)
# Target: 19,000+ TPS @ 5ms latency
# =============================================================================

# =============================================================================
# HUGEPAGES (calculated from shared_buffers)
# -----------------------------------------------------------------------------
# Formula: (shared_buffers_GB * 1024 / 2MB) * 1.07 overhead
# 20GB / 2MB = 10240, +7% = ~11000
# =============================================================================
VM_NR_HUGEPAGES=11000

# =============================================================================
# POSTGRESQL - PATHS
# =============================================================================
PG_VERSION=16
PG_DATA_DIR="/data/postgresql"
PG_WAL_DIR="/wal/pg_wal"
PG_LISTEN_ADDRESSES="*"
PG_PORT=5432

# =============================================================================
# POSTGRESQL - CONNECTIONS & MEMORY
# -----------------------------------------------------------------------------
# shared_buffers = 20GB (~31% of 64GB RAM) - optimal with HugePages
# effective_cache_size = 44GB (70% RAM) - accounts for OS page cache
# work_mem = 54MB - balanced for 300 connections (OLTP doesn't need much)
# =============================================================================
PG_MAX_CONNECTIONS=300
PG_SHARED_BUFFERS="20GB"
PG_HUGE_PAGES="on"
PG_WORK_MEM="54MB"
PG_MAINTENANCE_WORK_MEM="1GB"
PG_EFFECTIVE_CACHE_SIZE="44GB"

# =============================================================================
# POSTGRESQL - DISK I/O
# =============================================================================
PG_RANDOM_PAGE_COST="1.1"
PG_SEQ_PAGE_COST="1.0"
PG_EFFECTIVE_IO_CONCURRENCY=200

# =============================================================================
# POSTGRESQL - WAL
# -----------------------------------------------------------------------------
# wal_buffers = 256MB - large buffer reduces WAL contention at high TPS
# =============================================================================
PG_WAL_COMPRESSION="lz4"
PG_WAL_BUFFERS="256MB"
PG_WAL_WRITER_DELAY="10ms"
PG_WAL_WRITER_FLUSH_AFTER="1MB"

# =============================================================================
# POSTGRESQL - CHECKPOINT
# -----------------------------------------------------------------------------
# max_wal_size = 100GB - prevents checkpoint pressure during benchmarks
# checkpoint_timeout = 60min - reduces checkpoint frequency
# =============================================================================
PG_MAX_WAL_SIZE="100GB"
PG_MIN_WAL_SIZE="4GB"
PG_CHECKPOINT_TIMEOUT="1h"
PG_CHECKPOINT_COMPLETION_TARGET="0.9"

# =============================================================================
# POSTGRESQL - SYNC & GROUP COMMIT
# -----------------------------------------------------------------------------
# commit_delay=0 - disable batching, let hardware handle write latency
# Finding: commit_delay=0 outperforms batching on fast EBS storage
# =============================================================================
PG_SYNCHRONOUS_COMMIT="on"
PG_COMMIT_DELAY=0
PG_COMMIT_SIBLINGS=5

# =============================================================================
# POSTGRESQL - BACKGROUND WRITER
# -----------------------------------------------------------------------------
# bgwriter_delay=10ms (100x/sec) - aggressive flushing prevents I/O cliff
# =============================================================================
PG_BGWRITER_DELAY="10ms"
PG_BGWRITER_LRU_MAXPAGES=1000
PG_BGWRITER_LRU_MULTIPLIER="4.0"

# =============================================================================
# POSTGRESQL - AUTOVACUUM
# =============================================================================
PG_AUTOVACUUM="on"
PG_AUTOVACUUM_MAX_WORKERS=4
PG_AUTOVACUUM_NAPTIME="1min"
PG_AUTOVACUUM_VACUUM_SCALE_FACTOR="0.05"
PG_AUTOVACUUM_ANALYZE_SCALE_FACTOR="0.02"
PG_AUTOVACUUM_VACUUM_COST_LIMIT=10000

# =============================================================================
# POSTGRESQL - PARALLEL QUERY (limited for OLTP)
# =============================================================================
PG_MAX_WORKER_PROCESSES=8
PG_MAX_PARALLEL_WORKERS_PER_GATHER=4
PG_MAX_PARALLEL_WORKERS=8
PG_JIT="off"

# =============================================================================
# POSTGRESQL - LOGGING
# =============================================================================
PG_LOG_MIN_DURATION_STATEMENT=1000
PG_LOG_TEMP_FILES=0
PG_LOG_CHECKPOINTS="on"
PG_LOG_LOCK_WAITS="on"

# =============================================================================
# PGBENCH CONFIG
# -----------------------------------------------------------------------------
# Scale 1250 = ~20GB dataset, fits in 20GB shared_buffers
# =============================================================================
PGBENCH_SCALE=1250
PGBENCH_DURATION=60
PGBENCH_CLIENTS_LIGHT=4
PGBENCH_CLIENTS_MEDIUM=16
PGBENCH_CLIENTS_HEAVY=100
