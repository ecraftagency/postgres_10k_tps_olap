# =============================================================================
# WORKLOAD CONTEXT: TPC-B (pgbench OLTP)
# =============================================================================
# Optimized for: Write-intensive OLTP transactions
# Benchmark tool: pgbench
#
# Memory settings (shared_buffers, work_mem, etc.) are AUTO-CALCULATED
# by config_loader.py based on hardware RAM/vCPU. Only workload-specific
# tuning is defined here.
# =============================================================================

# =============================================================================
# POSTGRESQL - PATHS
# =============================================================================
PG_VERSION=16
PG_DATA_DIR="/data/postgresql"
PG_WAL_DIR="/wal/pg_wal"
PG_LISTEN_ADDRESSES="*"
PG_PORT=5432

# =============================================================================
# POSTGRESQL - CONNECTIONS
# =============================================================================
PG_MAX_CONNECTIONS=300
PG_HUGE_PAGES="try"

# =============================================================================
# POSTGRESQL - MEMORY RATIOS (used by config_loader for calculation)
# -----------------------------------------------------------------------------
# shared_buffers = RAM * 0.25 (OLTP)
# work_mem = (RAM * 0.05) / max_connections
# effective_cache_size = RAM * 0.70
# =============================================================================
PG_SHARED_BUFFERS_RATIO=0.25

# =============================================================================
# POSTGRESQL - DISK I/O
# =============================================================================
PG_RANDOM_PAGE_COST="1.1"
PG_SEQ_PAGE_COST="1.0"
PG_EFFECTIVE_IO_CONCURRENCY=200

# =============================================================================
# POSTGRESQL - WAL
# =============================================================================
PG_WAL_COMPRESSION="lz4"
PG_WAL_WRITER_DELAY="10ms"
PG_WAL_WRITER_FLUSH_AFTER="1MB"

# =============================================================================
# POSTGRESQL - CHECKPOINT
# -----------------------------------------------------------------------------
# checkpoint_timeout = 30min - frequent checkpoints for recovery safety
# =============================================================================
PG_MIN_WAL_SIZE="4GB"
PG_CHECKPOINT_TIMEOUT="30min"
PG_CHECKPOINT_COMPLETION_TARGET="0.9"

# =============================================================================
# POSTGRESQL - SYNC & GROUP COMMIT
# -----------------------------------------------------------------------------
# commit_delay=0 - disable batching, let hardware handle write latency
# Finding: commit_delay=0 outperforms batching on fast EBS storage
# =============================================================================
PG_SYNCHRONOUS_COMMIT="on"
PG_COMMIT_DELAY=0
PG_COMMIT_SIBLINGS=5

# =============================================================================
# POSTGRESQL - BACKGROUND WRITER
# -----------------------------------------------------------------------------
# bgwriter_delay=10ms (100x/sec) - aggressive flushing prevents I/O cliff
# bgwriter_lru_maxpages auto-calculated based on vCPU
# =============================================================================
PG_BGWRITER_DELAY="10ms"
PG_BGWRITER_LRU_MULTIPLIER="4.0"

# =============================================================================
# POSTGRESQL - AUTOVACUUM
# -----------------------------------------------------------------------------
# autovacuum_max_workers auto-calculated based on vCPU
# =============================================================================
PG_AUTOVACUUM="on"
PG_AUTOVACUUM_NAPTIME="1min"
PG_AUTOVACUUM_VACUUM_SCALE_FACTOR="0.05"
PG_AUTOVACUUM_ANALYZE_SCALE_FACTOR="0.02"
PG_AUTOVACUUM_VACUUM_COST_LIMIT=10000

# =============================================================================
# POSTGRESQL - PARALLEL QUERY (limited for OLTP)
# -----------------------------------------------------------------------------
# max_parallel_workers auto-calculated based on vCPU
# =============================================================================
PG_JIT="off"

# =============================================================================
# POSTGRESQL - LOGGING
# =============================================================================
PG_LOG_MIN_DURATION_STATEMENT=1000
PG_LOG_TEMP_FILES=0
PG_LOG_CHECKPOINTS="on"
PG_LOG_LOCK_WAITS="on"

# =============================================================================
# PGBENCH CONFIG
# -----------------------------------------------------------------------------
# PGBENCH_SCALE auto-calculated to fit ~80% of shared_buffers
# =============================================================================
PGBENCH_DURATION=60
PGBENCH_CLIENTS_LIGHT=4
PGBENCH_CLIENTS_MEDIUM=16
PGBENCH_CLIENTS_HEAVY=100
