# =============================================================================
# HARDWARE CONTEXT: r8g.xlarge.12.5.10.8disk.raid10
# =============================================================================
# Instance: r8g.xlarge (Memory Optimized, Graviton4)
# vCPU: 4 | RAM: 32 GB | Network: 12.5 Gbps | EBS: 10 Gbps
# Disk Array: 8 x 50 GB gp3 (raid10) = 200 GB usable
# -----------------------------------------------------------------------------
# TARGET: 10,000 TPS @ ~$145/month (50% cost reduction vs r8g.2xlarge)
# -----------------------------------------------------------------------------
# Tuned: 2026-01-04
# =============================================================================

# =============================================================================
# OS TUNING - MEMORY
# =============================================================================
VM_SWAPPINESS=1
# HugePages: 8GB shared_buffers / 2MB page size = 4096, +7% overhead = ~4400
VM_NR_HUGEPAGES=4400
VM_DIRTY_BACKGROUND_RATIO=1
VM_DIRTY_RATIO=4
VM_DIRTY_EXPIRE_CENTISECS=200
VM_DIRTY_WRITEBACK_CENTISECS=100
VM_OVERCOMMIT_MEMORY=2
VM_OVERCOMMIT_RATIO=80
VM_MIN_FREE_KBYTES=335544
VM_ZONE_RECLAIM_MODE=0

# =============================================================================
# OS TUNING - FILE DESCRIPTORS
# =============================================================================
FS_FILE_MAX=2097152
FS_AIO_MAX_NR=1048576
ULIMIT_NOFILE=65535
ULIMIT_NPROC=65535

# =============================================================================
# OS TUNING - NETWORK/TCP
# =============================================================================
NET_CORE_SOMAXCONN=4096
NET_CORE_NETDEV_MAX_BACKLOG=2048
NET_CORE_RMEM_DEFAULT=262144
NET_CORE_RMEM_MAX=16777216
NET_CORE_WMEM_DEFAULT=262144
NET_CORE_WMEM_MAX=16777216
NET_IPV4_TCP_RMEM="4096 87380 16777216"
NET_IPV4_TCP_WMEM="4096 65536 16777216"
NET_IPV4_TCP_MAX_SYN_BACKLOG=4096
NET_IPV4_TCP_TW_REUSE=1
NET_IPV4_TCP_FIN_TIMEOUT=15

# =============================================================================
# OS TUNING - SCHEDULER
# =============================================================================
KERNEL_SCHED_AUTOGROUP_ENABLED=0
KERNEL_NUMA_BALANCING=0
KERNEL_SEM="250 32000 100 128"

# =============================================================================
# RAID CONFIG - DATA VOLUME
# =============================================================================
DATA_MOUNT="/data"
DATA_DISK_SIZE_GB=50
DATA_DISK_COUNT=8
DATA_RAID_LEVEL=10
DATA_RAID_DEVICE="/dev/md0"
DATA_RAID_CHUNK="64K"
DATA_STRIPE_WIDTH=4

# =============================================================================
# RAID CONFIG - WAL VOLUME
# =============================================================================
WAL_MOUNT="/wal"
WAL_DISK_SIZE_GB=30
WAL_DISK_COUNT=8
WAL_RAID_LEVEL=10
WAL_RAID_DEVICE="/dev/md1"
WAL_RAID_CHUNK="256K"
WAL_STRIPE_WIDTH=4

# =============================================================================
# XFS OPTIONS
# =============================================================================
FS_TYPE="xfs"
XFS_DATA_SUNIT="64k"
XFS_WAL_SUNIT="256k"
XFS_LOG_STRIPE_UNIT="1b"
XFS_DATA_AGCOUNT=16
XFS_WAL_AGCOUNT=8
XFS_MOUNT_OPTS_DATA="defaults,noatime,nodiratime,logbufs=8,logbsize=256k,allocsize=64m,inode64"
XFS_MOUNT_OPTS_WAL="defaults,noatime,nodiratime,logbufs=8,logbsize=256k,inode64"

# =============================================================================
# BLOCK DEVICE TUNING - DATA
# =============================================================================
DATA_SCHEDULER="none"
DATA_ROTATIONAL=0
DATA_READ_AHEAD_KB=64
DATA_NR_REQUESTS=256
DATA_MAX_SECTORS_KB=256
DATA_RQ_AFFINITY=2
DATA_ADD_RANDOM=0
DATA_NOMERGES=0

# =============================================================================
# BLOCK DEVICE TUNING - WAL
# =============================================================================
WAL_SCHEDULER="none"
WAL_ROTATIONAL=0
WAL_READ_AHEAD_KB=4096
WAL_NR_REQUESTS=128
WAL_MAX_SECTORS_KB=256
WAL_RQ_AFFINITY=2
WAL_ADD_RANDOM=0
WAL_NOMERGES=0

# =============================================================================
# MDADM TUNING
# =============================================================================
MD_STRIPE_CACHE_SIZE=8192

# =============================================================================
# BENCHMARK CONFIG
# =============================================================================
FIO_RUNTIME=60
FIO_SIZE="1G"
FIO_NUMJOBS=4
BENCHMARK_RESULT_DIR="./results"

# =============================================================================
# POSTGRESQL - PATHS
# =============================================================================
PG_VERSION=16
PG_DATA_DIR="/data/postgresql"
PG_WAL_DIR="/wal/pg_wal"
PG_LISTEN_ADDRESSES="*"
PG_PORT=5432

# =============================================================================
# POSTGRESQL - CONNECTIONS & MEMORY (TUNED FOR 32GB RAM)
# -----------------------------------------------------------------------------
# shared_buffers = 8GB (25% RAM) - optimal for 32GB with HugePages
# effective_cache_size = 22GB (70% RAM) - accounts for OS page cache
# work_mem = 27MB - balanced for 300 connections (8GB total work_mem budget)
# =============================================================================
PG_MAX_CONNECTIONS=300
PG_SHARED_BUFFERS="8GB"
PG_HUGE_PAGES="on"
PG_WORK_MEM="27MB"
PG_MAINTENANCE_WORK_MEM="512MB"
PG_EFFECTIVE_CACHE_SIZE="22GB"

# =============================================================================
# POSTGRESQL - DISK I/O (CALCULATED)
# =============================================================================
PG_RANDOM_PAGE_COST="1.1"
PG_SEQ_PAGE_COST="1.0"
PG_EFFECTIVE_IO_CONCURRENCY=100

# =============================================================================
# POSTGRESQL - WAL (TUNED FOR 4 vCPU)
# -----------------------------------------------------------------------------
# wal_buffers = 128MB - proportional buffer for 10K TPS target
# =============================================================================
PG_WAL_COMPRESSION="lz4"
PG_WAL_BUFFERS="128MB"
PG_WAL_WRITER_DELAY="10ms"
PG_WAL_WRITER_FLUSH_AFTER="2MB"

# =============================================================================
# POSTGRESQL - CHECKPOINT (TUNED FOR 10K TPS TARGET)
# -----------------------------------------------------------------------------
# max_wal_size = 50GB - proportional for smaller instance
# checkpoint_timeout = 60min - reduces checkpoint frequency
# =============================================================================
PG_MAX_WAL_SIZE="50GB"
PG_MIN_WAL_SIZE="2GB"
PG_CHECKPOINT_TIMEOUT="1h"
PG_CHECKPOINT_COMPLETION_TARGET="0.9"

# =============================================================================
# POSTGRESQL - SYNC & GROUP COMMIT (SCENARIO C TUNED)
# -----------------------------------------------------------------------------
# commit_delay=0 - disable batching, let hardware handle write latency
# commit_siblings=5 - reduced threshold for group commit
# Finding: commit_delay=0 outperforms batching on fast EBS storage
# =============================================================================
PG_SYNCHRONOUS_COMMIT="on"
PG_COMMIT_DELAY=0
PG_COMMIT_SIBLINGS=3

# =============================================================================
# POSTGRESQL - BACKGROUND WRITER (TUNED FOR 4 vCPU)
# -----------------------------------------------------------------------------
# bgwriter_delay=10ms (100x/sec) - aggressive flushing prevents I/O cliff
# bgwriter_lru_multiplier=4.0 - more aggressive to reduce backend writes
# bgwriter_lru_maxpages=500 - scaled for 4 vCPU
# =============================================================================
PG_BGWRITER_DELAY="10ms"
PG_BGWRITER_LRU_MAXPAGES=500
PG_BGWRITER_LRU_MULTIPLIER="4.0"

# =============================================================================
# POSTGRESQL - AUTOVACUUM
# =============================================================================
PG_AUTOVACUUM="on"
PG_AUTOVACUUM_MAX_WORKERS=2
PG_AUTOVACUUM_NAPTIME="1min"
PG_AUTOVACUUM_VACUUM_SCALE_FACTOR="0.05"
PG_AUTOVACUUM_ANALYZE_SCALE_FACTOR="0.02"
PG_AUTOVACUUM_VACUUM_COST_LIMIT=10000

# =============================================================================
# POSTGRESQL - PARALLEL QUERY (CALCULATED from 4 vCPU)
# =============================================================================
PG_MAX_WORKER_PROCESSES=4
PG_MAX_PARALLEL_WORKERS_PER_GATHER=2
PG_MAX_PARALLEL_WORKERS=4

# =============================================================================
# POSTGRESQL - LOGGING
# =============================================================================
PG_LOG_MIN_DURATION_STATEMENT=1000
PG_LOG_TEMP_FILES=0
PG_LOG_CHECKPOINTS="on"
PG_LOG_LOCK_WAITS="on"

# =============================================================================
# PGBENCH CONFIG
# -----------------------------------------------------------------------------
# Scale 500 = ~8GB dataset, fits comfortably in 8GB shared_buffers
# =============================================================================
PGBENCH_SCALE=500
PGBENCH_DURATION=60
PGBENCH_CLIENTS_LIGHT=4
PGBENCH_CLIENTS_MEDIUM=16
PGBENCH_CLIENTS_HEAVY=100
