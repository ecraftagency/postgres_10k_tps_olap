# =============================================================================
# HARDWARE CONTEXT: r8g.2xlarge.15.10.8disk.raid10
# =============================================================================
# ██████╗ ██████╗  ██████╗ ██████╗ ██╗   ██╗ ██████╗████████╗██╗ ██████╗ ███╗   ██╗
# ██╔══██╗██╔══██╗██╔═══██╗██╔══██╗██║   ██║██╔════╝╚══██╔══╝██║██╔═══██╗████╗  ██║
# ██████╔╝██████╔╝██║   ██║██║  ██║██║   ██║██║        ██║   ██║██║   ██║██╔██╗ ██║
# ██╔═══╝ ██╔══██╗██║   ██║██║  ██║██║   ██║██║        ██║   ██║██║   ██║██║╚██╗██║
# ██║     ██║  ██║╚██████╔╝██████╔╝╚██████╔╝╚██████╗   ██║   ██║╚██████╔╝██║ ╚████║
# ╚═╝     ╚═╝  ╚═╝ ╚═════╝ ╚═════╝  ╚═════╝  ╚═════╝   ╚═╝   ╚═╝ ╚═════╝ ╚═╝  ╚═══╝
# ██████╗ ███████╗ █████╗ ██████╗ ██╗   ██╗    ✓
# ██╔══██╗██╔════╝██╔══██╗██╔══██╗╚██╗ ██╔╝
# ██████╔╝█████╗  ███████║██║  ██║ ╚████╔╝
# ██╔══██╗██╔══╝  ██╔══██║██║  ██║  ╚██╔╝
# ██║  ██║███████╗██║  ██║██████╔╝   ██║
# ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚═════╝    ╚═╝
# =============================================================================
# Instance: r8g.2xlarge (Memory Optimized, Graviton3)
# vCPU: 8 | RAM: 64 GB | Network: 15 Gbps | EBS: 10 Gbps
# Disk Array: 8 x 50 GB gp3 (raid10) = 200 GB usable
# -----------------------------------------------------------------------------
# BENCHMARK RESULT: 19,527 TPS @ 5.12ms latency (Direct)
#                   20,754 TPS @ 48ms latency (via PgCat, 1000 clients)
# PRICE/PERF: 67.3 TPS/$ (+38% better than c8gb.8xlarge)
# -----------------------------------------------------------------------------
# Base: scripts/hardware/generate-config.sh
# Tuned: 2026-01-04 (Scenario C: HugePages + WAL optimization)
# =============================================================================

# =============================================================================
# OS TUNING - MEMORY
# =============================================================================
VM_SWAPPINESS=1
# HugePages: 20GB shared_buffers / 2MB page size = 10240, +7% overhead = ~11000
VM_NR_HUGEPAGES=11000
VM_DIRTY_BACKGROUND_RATIO=1
VM_DIRTY_RATIO=4
VM_DIRTY_EXPIRE_CENTISECS=200
VM_DIRTY_WRITEBACK_CENTISECS=100
VM_OVERCOMMIT_MEMORY=2
VM_OVERCOMMIT_RATIO=80
VM_MIN_FREE_KBYTES=671088
VM_ZONE_RECLAIM_MODE=0

# =============================================================================
# OS TUNING - FILE DESCRIPTORS
# =============================================================================
FS_FILE_MAX=2097152
FS_AIO_MAX_NR=1048576
ULIMIT_NOFILE=65535
ULIMIT_NPROC=65535

# =============================================================================
# OS TUNING - NETWORK/TCP
# =============================================================================
NET_CORE_SOMAXCONN=4096
NET_CORE_NETDEV_MAX_BACKLOG=2048
NET_CORE_RMEM_DEFAULT=262144
NET_CORE_RMEM_MAX=16777216
NET_CORE_WMEM_DEFAULT=262144
NET_CORE_WMEM_MAX=16777216
NET_IPV4_TCP_RMEM="4096 87380 16777216"
NET_IPV4_TCP_WMEM="4096 65536 16777216"
NET_IPV4_TCP_MAX_SYN_BACKLOG=4096
NET_IPV4_TCP_TW_REUSE=1
NET_IPV4_TCP_FIN_TIMEOUT=15

# =============================================================================
# OS TUNING - SCHEDULER
# =============================================================================
KERNEL_SCHED_AUTOGROUP_ENABLED=0
KERNEL_NUMA_BALANCING=0
KERNEL_SEM="250 32000 100 128"

# =============================================================================
# RAID CONFIG - DATA VOLUME
# =============================================================================
DATA_MOUNT="/data"
DATA_DISK_SIZE_GB=50
DATA_DISK_COUNT=8
DATA_RAID_LEVEL=10
DATA_RAID_DEVICE="/dev/md0"
DATA_RAID_CHUNK="64K"
DATA_STRIPE_WIDTH=4

# =============================================================================
# RAID CONFIG - WAL VOLUME
# =============================================================================
WAL_MOUNT="/wal"
WAL_DISK_SIZE_GB=30
WAL_DISK_COUNT=8
WAL_RAID_LEVEL=10
WAL_RAID_DEVICE="/dev/md1"
WAL_RAID_CHUNK="256K"
WAL_STRIPE_WIDTH=4

# =============================================================================
# XFS OPTIONS
# =============================================================================
FS_TYPE="xfs"
XFS_DATA_SUNIT="64k"
XFS_WAL_SUNIT="256k"
XFS_LOG_STRIPE_UNIT="1b"
XFS_DATA_AGCOUNT=16
XFS_WAL_AGCOUNT=8
XFS_MOUNT_OPTS_DATA="defaults,noatime,nodiratime,logbufs=8,logbsize=256k,allocsize=64m,inode64"
XFS_MOUNT_OPTS_WAL="defaults,noatime,nodiratime,logbufs=8,logbsize=256k,inode64"

# =============================================================================
# BLOCK DEVICE TUNING - DATA
# =============================================================================
DATA_SCHEDULER="none"
DATA_ROTATIONAL=0
DATA_READ_AHEAD_KB=64
DATA_NR_REQUESTS=256
DATA_MAX_SECTORS_KB=256
DATA_RQ_AFFINITY=2
DATA_ADD_RANDOM=0
DATA_NOMERGES=0

# =============================================================================
# BLOCK DEVICE TUNING - WAL
# =============================================================================
WAL_SCHEDULER="none"
WAL_ROTATIONAL=0
WAL_READ_AHEAD_KB=4096
WAL_NR_REQUESTS=128
WAL_MAX_SECTORS_KB=256
WAL_RQ_AFFINITY=2
WAL_ADD_RANDOM=0
WAL_NOMERGES=0

# =============================================================================
# MDADM TUNING
# =============================================================================
MD_STRIPE_CACHE_SIZE=8192

# =============================================================================
# BENCHMARK CONFIG
# =============================================================================
FIO_RUNTIME=60
FIO_SIZE="1G"
FIO_NUMJOBS=4
BENCHMARK_RESULT_DIR="./results"

# =============================================================================
# POSTGRESQL - PATHS
# =============================================================================
PG_VERSION=16
PG_DATA_DIR="/data/postgresql"
PG_WAL_DIR="/wal/pg_wal"
PG_LISTEN_ADDRESSES="*"
PG_PORT=5432

# =============================================================================
# POSTGRESQL - CONNECTIONS & MEMORY (SCENARIO C TUNED)
# -----------------------------------------------------------------------------
# shared_buffers = 20GB (~31% RAM) - optimal for 64GB with HugePages
# effective_cache_size = 44GB (70% RAM) - accounts for OS page cache
# work_mem = 54MB - balanced for 300 connections
# =============================================================================
PG_MAX_CONNECTIONS=300
PG_SHARED_BUFFERS="20GB"
PG_HUGE_PAGES="on"
PG_WORK_MEM="54MB"
PG_MAINTENANCE_WORK_MEM="1GB"
PG_EFFECTIVE_CACHE_SIZE="44GB"

# =============================================================================
# POSTGRESQL - DISK I/O (CALCULATED)
# =============================================================================
PG_RANDOM_PAGE_COST="1.1"
PG_SEQ_PAGE_COST="1.0"
PG_EFFECTIVE_IO_CONCURRENCY=200

# =============================================================================
# POSTGRESQL - WAL (SCENARIO C TUNED)
# -----------------------------------------------------------------------------
# wal_buffers = 256MB - large buffer reduces WAL contention at high TPS
# =============================================================================
PG_WAL_COMPRESSION="lz4"
PG_WAL_BUFFERS="256MB"
PG_WAL_WRITER_DELAY="10ms"
PG_WAL_WRITER_FLUSH_AFTER="1MB"

# =============================================================================
# POSTGRESQL - CHECKPOINT (SCENARIO C TUNED)
# -----------------------------------------------------------------------------
# max_wal_size = 100GB - prevents checkpoint pressure during benchmarks
# checkpoint_timeout = 60min - reduces checkpoint frequency
# =============================================================================
PG_MAX_WAL_SIZE="100GB"
PG_MIN_WAL_SIZE="4GB"
PG_CHECKPOINT_TIMEOUT="1h"
PG_CHECKPOINT_COMPLETION_TARGET="0.9"

# =============================================================================
# POSTGRESQL - SYNC & GROUP COMMIT (SCENARIO C TUNED)
# -----------------------------------------------------------------------------
# commit_delay=0 - disable batching, let hardware handle write latency
# commit_siblings=5 - reduced threshold for group commit
# Finding: commit_delay=0 outperforms batching on fast EBS storage
# =============================================================================
PG_SYNCHRONOUS_COMMIT="on"
PG_COMMIT_DELAY=0
PG_COMMIT_SIBLINGS=5

# =============================================================================
# POSTGRESQL - BACKGROUND WRITER (SCENARIO C TUNED)
# -----------------------------------------------------------------------------
# bgwriter_delay=10ms (100x/sec) - aggressive flushing prevents I/O cliff
# bgwriter_lru_multiplier=4.0 - sufficient for 8 vCPU instance
# =============================================================================
PG_BGWRITER_DELAY="10ms"
PG_BGWRITER_LRU_MAXPAGES=1000
PG_BGWRITER_LRU_MULTIPLIER="4.0"

# =============================================================================
# POSTGRESQL - AUTOVACUUM
# =============================================================================
PG_AUTOVACUUM="on"
PG_AUTOVACUUM_MAX_WORKERS=4
PG_AUTOVACUUM_NAPTIME="1min"
PG_AUTOVACUUM_VACUUM_SCALE_FACTOR="0.05"
PG_AUTOVACUUM_ANALYZE_SCALE_FACTOR="0.02"
PG_AUTOVACUUM_VACUUM_COST_LIMIT=10000

# =============================================================================
# POSTGRESQL - PARALLEL QUERY (CALCULATED from vCPU)
# =============================================================================
PG_MAX_WORKER_PROCESSES=8
PG_MAX_PARALLEL_WORKERS_PER_GATHER=4
PG_MAX_PARALLEL_WORKERS=8

# =============================================================================
# POSTGRESQL - LOGGING
# =============================================================================
PG_LOG_MIN_DURATION_STATEMENT=1000
PG_LOG_TEMP_FILES=0
PG_LOG_CHECKPOINTS="on"
PG_LOG_LOCK_WAITS="on"

# =============================================================================
# PGBENCH CONFIG
# -----------------------------------------------------------------------------
# Scale 1250 = ~20GB dataset, fits comfortably in 20GB shared_buffers
# =============================================================================
PGBENCH_SCALE=1250
PGBENCH_DURATION=60
PGBENCH_CLIENTS_LIGHT=4
PGBENCH_CLIENTS_MEDIUM=16
PGBENCH_CLIENTS_HEAVY=100
