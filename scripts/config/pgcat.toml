# =============================================================================
# PgCat Configuration
# =============================================================================
# PostgreSQL connection pooler - https://github.com/postgresml/pgcat
# Default port: 6432
# =============================================================================

[general]
# Bind address and port
host = "0.0.0.0"
port = 6432

# Worker threads: 2x vCPU for concurrency (c8g.xlarge = 4 vCPU)
worker_threads = 8

# Enable admin database for stats
admin_username = "admin"
admin_password = "admin"

# Connection timeout (ms)
connect_timeout = 5000

# Idle timeout before closing server connection (ms)
idle_timeout = 30000

# TCP keepalive (seconds)
tcp_keepalives_idle = 5
tcp_keepalives_count = 5
tcp_keepalives_interval = 1

# Shutdown timeout (ms)
shutdown_timeout = 60000

# Health check interval (ms)
healthcheck_delay = 30000
healthcheck_timeout = 1000

# Ban time for unhealthy servers (seconds)
ban_time = 60

# Log level: debug, info, warn, error
log_level = "info"

# =============================================================================
# Connection Pools
# =============================================================================

[pools.bench]
# Pool mode: session, transaction, statement
pool_mode = "transaction"

# Load balancing: random, round_robin, least_connections
load_balancing_mode = "random"

# Default database and user
default_role = "primary"

# Query parser (for prepared statements): disabled, simple
query_parser_enabled = true
query_parser_read_write_splitting = false

# Pool sizing
pool_size = 50
min_pool_size = 5

# Statement cache for prepared statements
prepared_statements_cache_size = 200

# Sharding disabled (single primary)

# Users
[pools.bench.users.0]
username = "postgres"
password = "postgres"
pool_size = 50
min_pool_size = 5

# Shards (single primary)
[pools.bench.shards.0]
database = "bench"
servers = [
    ["10.0.1.10", 5432, "primary"]
]

# =============================================================================
# Postgres Pool - For monitoring/diagnostics (pg_stat_*, etc.)
# =============================================================================

[pools.postgres]
pool_mode = "transaction"
load_balancing_mode = "random"
default_role = "primary"
query_parser_enabled = true
query_parser_read_write_splitting = false
pool_size = 20
min_pool_size = 5

[pools.postgres.users.0]
username = "postgres"
password = "postgres"
pool_size = 20
min_pool_size = 5

[pools.postgres.shards.0]
database = "postgres"
servers = [
    ["10.0.1.10", 5432, "primary"]
]

# =============================================================================
# Primary-Replica Configuration (future)
# =============================================================================
# Uncomment when replica is added:
#
# [pools.bench.shards.0]
# database = "bench"
# servers = [
#     ["10.0.1.10", 5432, "primary"],
#     ["10.0.1.11", 5432, "replica"]
# ]
#
# Then set:
# query_parser_read_write_splitting = true
# =============================================================================
