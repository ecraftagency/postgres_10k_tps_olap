# =============================================================================
# PgCat Configuration - Read/Write Split with Replicas
# =============================================================================
# PostgreSQL connection pooler - https://github.com/postgresml/pgcat
# Target: Route writes to primary, reads to replicas
# Hardware: c8g.xlarge proxy (4 vCPU, 8GB RAM)
# Topology: 1 primary + 1 sync replica + 1 async replica
# =============================================================================

[general]
host = "0.0.0.0"
port = 6432

# Worker threads: 2x vCPU for concurrency
worker_threads = 8

# Admin interface
admin_username = "admin"
admin_password = "admin"

# === LOW LATENCY TUNING ===
# Fast connection establishment
connect_timeout = 1000

# Keep connections alive longer (reduce reconnect overhead)
idle_timeout = 600000
server_lifetime = 86400000

# Aggressive TCP keepalive for fast failure detection
tcp_keepalives_idle = 5
tcp_keepalives_count = 3
tcp_keepalives_interval = 1

# Shutdown
shutdown_timeout = 60000

# Health checks - frequent for fast failover detection
healthcheck_delay = 5000
healthcheck_timeout = 1000

# Quick recovery from failures
ban_time = 30

# Reduce logging overhead
log_level = "warn"

# =============================================================================
# Bench Pool - OLTP with Read/Write Split
# =============================================================================

[pools.bench]
pool_mode = "transaction"
load_balancing_mode = "random"
default_role = "primary"

# === READ/WRITE SPLITTING ===
# Enable query parser for automatic routing
query_parser_enabled = true
query_parser_read_write_splitting = true

# Large pool to handle burst traffic without waiting
pool_size = 200
min_pool_size = 100

# Disable prepared statement cache (pgbench uses simple protocol)
prepared_statements_cache_size = 0

[pools.bench.users.0]
username = "postgres"
password = "postgres"
pool_size = 200
min_pool_size = 100

[pools.bench.shards.0]
database = "bench"
servers = [
    ["10.0.1.10", 5432, "primary"],
    ["10.0.1.11", 5432, "replica"],
    ["10.0.1.12", 5432, "replica"]
]

# =============================================================================
# Sysbench Pool - TPC-C Workloads with Read/Write Split
# =============================================================================

[pools.sysbench]
pool_mode = "transaction"
load_balancing_mode = "random"
default_role = "primary"
query_parser_enabled = true
query_parser_read_write_splitting = true
pool_size = 200
min_pool_size = 100
prepared_statements_cache_size = 0

[pools.sysbench.users.0]
username = "postgres"
password = "postgres"
pool_size = 200
min_pool_size = 100

[pools.sysbench.shards.0]
database = "sysbench"
servers = [
    ["10.0.1.10", 5432, "primary"],
    ["10.0.1.11", 5432, "replica"],
    ["10.0.1.12", 5432, "replica"]
]

# =============================================================================
# Postgres Pool - For monitoring/diagnostics (primary only)
# =============================================================================

[pools.postgres]
pool_mode = "transaction"
load_balancing_mode = "random"
default_role = "primary"
query_parser_enabled = false
query_parser_read_write_splitting = false
pool_size = 20
min_pool_size = 5

[pools.postgres.users.0]
username = "postgres"
password = "postgres"
pool_size = 20
min_pool_size = 5

[pools.postgres.shards.0]
database = "postgres"
servers = [
    ["10.0.1.10", 5432, "primary"]
]
