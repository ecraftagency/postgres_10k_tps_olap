# =============================================================================
# PRIMARY CONFIG: r7g.xlarge PostgreSQL Primary Node
# =============================================================================
# Instance: r7g.xlarge (Memory Optimized, Graviton3)
# vCPU: 4 | RAM: 32 GB
# Role: Primary Database Node
# IP: 10.0.1.10
# =============================================================================

# === INSTANCE SPECS ===
INSTANCE_TYPE=r7g.xlarge
VCPU=4
RAM_GB=32

# === STORAGE CONFIG ===
DATA_DISK_COUNT=4
DATA_DISK_SIZE_GB=50
WAL_DISK_COUNT=4
WAL_DISK_SIZE_GB=30

# === POSTGRESQL - PATHS ===
PG_VERSION=16
PG_DATA_DIR=/data/postgresql
PG_WAL_DIR=/wal/pg_wal
PG_LISTEN_ADDRESSES=*
PG_PORT=5432

# === POSTGRESQL - CONNECTIONS ===
PG_MAX_CONNECTIONS=300

# === POSTGRESQL - MEMORY (fixed values for 32GB RAM) ===
PG_SHARED_BUFFERS=8GB
PG_EFFECTIVE_CACHE_SIZE=22GB
PG_WORK_MEM=128MB
PG_MAINTENANCE_WORK_MEM=1638MB
PG_HUGE_PAGES=try

# === POSTGRESQL - WAL ===
PG_WAL_LEVEL=replica
PG_WAL_COMPRESSION=lz4
PG_WAL_SYNC_METHOD=fdatasync
PG_WAL_BUFFERS=64MB
PG_WAL_WRITER_DELAY=10ms
PG_SYNCHRONOUS_COMMIT=on
PG_MAX_WAL_SIZE=32GB
PG_MIN_WAL_SIZE=2GB

# === POSTGRESQL - REPLICATION (Primary) ===
PG_MAX_WAL_SENDERS=10
PG_MAX_REPLICATION_SLOTS=10
PG_HOT_STANDBY=off
# Sync replica must acknowledge before commit returns
# Note: use underscore, not hyphen (PG identifier rules)
PG_SYNCHRONOUS_STANDBY_NAMES="sync_replica"

# === POSTGRESQL - GROUP COMMIT ===
PG_COMMIT_DELAY=10
PG_COMMIT_SIBLINGS=5

# === POSTGRESQL - CHECKPOINT ===
PG_CHECKPOINT_TIMEOUT=15min
PG_CHECKPOINT_COMPLETION_TARGET=0.9

# === POSTGRESQL - BACKGROUND WRITER ===
PG_BGWRITER_DELAY=10ms
PG_BGWRITER_LRU_MAXPAGES=400
PG_BGWRITER_LRU_MULTIPLIER=4

# === POSTGRESQL - PARALLEL ===
PG_MAX_WORKER_PROCESSES=4
PG_MAX_PARALLEL_WORKERS=4
PG_MAX_PARALLEL_WORKERS_PER_GATHER=2
PG_MAX_PARALLEL_MAINTENANCE_WORKERS=2

# === POSTGRESQL - I/O ===
PG_EFFECTIVE_IO_CONCURRENCY=200
PG_MAINTENANCE_IO_CONCURRENCY=10
PG_RANDOM_PAGE_COST=1.1
PG_SEQ_PAGE_COST=1.0

# === POSTGRESQL - AUTOVACUUM (Heavy write workload tuning) ===
PG_AUTOVACUUM=on
PG_TRACK_COUNTS=on
PG_AUTOVACUUM_VACUUM_SCALE_FACTOR=0.05
PG_AUTOVACUUM_ANALYZE_SCALE_FACTOR=0.02
PG_AUTOVACUUM_VACUUM_COST_LIMIT=2000
PG_AUTOVACUUM_VACUUM_COST_DELAY=2ms

# === POSTGRESQL - LOGGING ===
PG_LOGGING_COLLECTOR=on
PG_LOG_DIRECTORY=log
PG_LOG_FILENAME=postgresql-%Y-%m-%d_%H%M%S.log
PG_LOG_MIN_DURATION_STATEMENT=1000
PG_LOG_CHECKPOINTS=on
PG_LOG_LOCK_WAITS=on
PG_LOG_TEMP_FILES=0
PG_LOG_AUTOVACUUM_MIN_DURATION=0

# === POSTGRESQL - QUERY TUNING ===
PG_JIT=off

# === POSTGRESQL - STATS ===
PG_TRACK_IO_TIMING=on
PG_TRACK_WAL_IO_TIMING=on
